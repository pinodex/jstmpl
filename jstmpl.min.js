/**
 * jstmpl
 * Simple JavaScript Templating Engine
 *
 * @author    Raphael Marco <pinodex@outlook.ph>
 * @link      http://pinodex.github.io
 * @license   MIT
 */
(function(){window.Jstmpl=function(a){String.prototype.trim||(String.prototype.trim=function(){return this.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"")});this.options=a||{};this.context=this.options.context||document;this.fn={raw:function(a){return Jstmpl_Helpers.htmlUnescape(a)}};if(window.jstmpl_defaults){var b=Object.keys(window.jstmpl_defaults);for(a=b.length-1;0<=a;a--)this.options[b[a]]=window.jstmpl_defaults[b[a]]}if(this.options.fn)for(b=Object.keys(this.options.fn),a=b.length-1;0<=a;a--)this.fn[b[a]]=
this.options.fn[b[a]]};window.Jstmpl.prototype.template=function(a){return new Jstmpl_Template(this,a)};window.Jstmpl.prototype.addFunction=function(a,b){this.fn[a]=b};window.Jstmpl.prototype.debug=function(){return this.options.debug?{log:function(){console.log.apply(console,arguments)},warn:function(){console.warn.apply(console,arguments)},error:function(){console.error.apply(console,arguments)}}:{log:function(){},warn:function(){},error:function(){}}};window.Jstmpl_Template=function(a,b){this.jstmpl=
a;this.elements=a.context.querySelectorAll('[data-template="'+b+'"]')};window.Jstmpl_Template.prototype.regExp={variables:RegExp("{{ ([^}]+) }}","gm"),forloops:RegExp("{% for (.*?) in (.*?) %}((.*?|\n)+?){% endfor %}","gm"),conditionals:RegExp("{% if (.*?) %}((.*?|\n)+?){% endif %}","gm")};window.Jstmpl_Template.prototype.render=function(a){a=a||{};a=this.parse(a);for(var b=this.elements.length-1;0<=b;b--){var d;if(d=this.elements[b].getAttribute("data-target"))for(d=this.jstmpl.context.querySelectorAll(d),
b=d.length-1;0<=b;b--)d[b].innerHTML=a;else this.elements[b].innerHTML=a}return this};window.Jstmpl_Template.prototype.parse=function(a,b){a=a||{};b=b||this.elements[0].innerHTML;if(!b)return null;b=this.parseConditionals(b,a);b=this.parseForloops(b,a);b=this.parseVariables(b,a);return b.trim()};window.Jstmpl_Template.prototype.callback=function(a){a(this.elements)};window.Jstmpl_Template.prototype.parseVariables=function(a,b){for(var d=a.match(this.regExp.variables)||[],e=d.length-1;0<=e;e--){var c=
d[e].substr(3,d[e].length-6).split("|");c[0]=c[0].split(".");var f=b[c[0][0]];if(f){if(1<c[0].length)for(var g=1;g<c[0].length;g++)f?f=f[c[0][g]]:this.jstmpl.debug().error('Jstmpl: Undefined variable "%s" from "%s".',c[0][g],c[0].join("."));d[e]=d[e].replace(/\|/g,"\\|");f=Jstmpl_Helpers.htmlEscape(f);if(1<c.length)for(g=c.length-1;1<=g;g--)c[g]&&(c[g]in this.fn?f=this.fn[c[g]](f):this.jstmpl.debug().error('Jstmpl: Undefined function "%s".',c[g]));a=a.replace(new RegExp(d[e],"gm"),f)}else this.jstmpl.debug().error('Jstmpl: Undefined variable "%s".',
c[0].join("."))}return a};window.Jstmpl_Template.prototype.parseForloops=function(a,b){for(var d;null!=(d=this.regExp.forloops.exec(a));){var e=b[d[2]],c="";d[1]=d[1].replace(/ +/g," ").trim().split(",");if(1!=d[1].length&&2!=d[1].length)this.jstmpl.debug().error('Jstmpl: Invalid variable count for "%s" for loop.',d[2]);else if(e){for(var f=Object.keys(e),g={},h=0;h<f.length;h++){var k=Object.prototype.toString.call(e);"[object Array]"==k&&(g[d[1][0]]=String(e[h]));"[object Object]"==k&&(g[d[1][0]]=
String(f[h]));2==d[1].length&&(g[d[1][1]]=String(e[f[h]]));c+=this.parse(g,d[3])}d[0]=d[0].replace(/\|/g,"\\|");a=a.replace(new RegExp(d[0],"gm"),c)}else this.jstmpl.debug().error('Jstmpl: Undefined variable "%s".',d[2])}return a};window.Jstmpl_Template.prototype.parseConditionals=function(a,b,d){for(var e;null!=(e=this.regExp.conditionals.exec(a));){var c=e[1].replace(/ +/g," ").trim().split(" "),f=c[0],g=!1;"not"==f&&(c=c.splice(1),f=c[0],g=!0);"!"==f.charAt(0)&&(f=f.substr(1),g=!0);f in b||this.jstmpl.debug().warn('Jstmpl: Undefined variable "%s".',
f);var h=b[f];e[0]=new RegExp(e[0].replace(/\|/g,"\\|"),"gm");if(!g&&1==c.length&&h)a=a.replace(e[0],this.parse(b,e[2]));else{if(c[1]){var k=/["'](.*?)["']/.test(d),l=/(true|false)/i.test(d);k&&(c[2]=c[2].replace(/["'](.*?)["']/,"$1"));!k&&b[c[2]]&&(c[2]=b[c[2]]);l&&(c[2]="true"===c[2].toLowerCase());if(k=this.conditionTests[c[1]])h=k(b[f],c[2]);k||(this.jstmpl.debug().warn('Jstmpl: Undefined test function "%s".',c[1]),g=h=!1)}g&&(h=!h);a=h?a.replace(e[0],this.parse(b,e[2])):a.replace(e[0],"")}}return a};
window.Jstmpl_Template.prototype.conditionTests={equals:function(a,b){return a==b},"==":function(a,b){return this.equals(a,b)},startsWith:function(a,b){return 0==a.indexOf(b)},startswith:function(a,b){return this.startsWith(a,b)},contains:function(a,b){return 0<=a.indexOf(b)},is:function(a,b){return"empty"==b?!a:!1}};window.Jstmpl_Helpers={htmlEscape:function(a){return String(a).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;")},htmlUnescape:function(a){return String(a).replace(/&quot;/g,
'"').replace(/&#39;/g,"'").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&")}}})();